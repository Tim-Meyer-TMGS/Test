<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verteilseite · HTML-Dateien im Repo</title>
<meta name="description" content="Startseite, die alle HTML-Dateien im Repo-Root auflistet und verlinkt." />
<style>
  :root{
    --bg:#0b1020; --panel:#101936; --text:#e9edff; --muted:#aab2d5;
    --line:#1d2748; --accent:#5aa2ff; --card:#0f1834; --ok:#46c28b;
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:var(--bg); color:var(--text)}
  header{padding:28px 20px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(90,162,255,.12), transparent 30%)}
  .wrap{max-width:1100px; margin:0 auto; padding:0 20px}
  h1{margin:0 0 6px; font-size:clamp(22px,3.5vw,34px)}
  .meta{color:var(--muted); font-size:14px}
  .toolbar{display:grid; grid-template-columns:1fr auto auto; gap:10px; margin-top:16px}
  .toolbar input,.toolbar select{
    background:var(--panel); color:var(--text); border:1px solid var(--line);
    padding:10px 12px; border-radius:10px; font-size:14px
  }

  .section{padding:22px 0}
  h2{font-size:18px; margin:0 0 10px; color:#dfe6ff}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px;
    box-shadow:0 6px 22px rgba(0,0,0,.25); display:flex; flex-direction:column; min-height:120px
  }
  .card h3{margin:0 0 8px; font-size:16px}
  .card p{margin:0 0 10px; color:var(--muted); font-size:14px}
  .links{display:flex; gap:10px; margin-top:auto}
  .btn{display:inline-block; padding:8px 10px; border-radius:10px; text-decoration:none; color:var(--text); border:1px solid var(--line); background:transparent}
  .btn:hover{border-color:var(--accent)}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted)}
  .pill.ok{color:var(--ok); border-color:#2f6a54}
  .empty{color:var(--muted); border:1px dashed var(--line); padding:16px; border-radius:12px}
  footer{color:var(--muted); font-size:12px; padding:24px 20px; border-top:1px solid var(--line)}
  @media (max-width:720px){ .toolbar{grid-template-columns:1fr;}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Verteilseite</h1>
    <div class="meta" id="meta">lädt…</div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Suche nach Dateinamen … (z. B. „quali“)" />
      <select id="sort">
        <option value="name">Sortierung: Name A–Z</option>
        <option value="nameDesc">Sortierung: Name Z–A</option>
      </select>
      <select id="filter">
        <option value="all">Alle Dateien</option>
        <option value="featured">Nur „quali*“</option>
        <option value="nonfeatured">Ohne „quali*“</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="section" id="featuredSec" style="display:none">
    <h2>Empfohlen (<span id="featuredCount">0</span>)</h2>
    <div class="grid" id="featuredList"></div>
  </section>

  <section class="section">
    <h2>Alle HTMLs im Repo-Root (<span id="count">0</span>)</h2>
    <div class="grid" id="fileList"></div>
    <div id="empty" class="empty" style="display:none">Keine Dateien gefunden. Prüfe Branch/Ref oder Dateinamen.</div>
  </section>
</main>

<footer class="wrap">
  <span>Generated client-side via GitHub API · <span id="updated"></span></span>
</footer>

<script>
/** ========= KONFIG ========= */
const CONFIG = {
  // Präfix für „Empfohlen“ (leer lassen, um zu deaktivieren)
  featuredPrefix: 'quali',
  // Falls Auto-Erkennung von Owner/Repo scheitert, hier fallback setzen (oder via URL-Params owner/repo/ref übergeben)
  fallbackOwner: '',
  fallbackRepo: '',
  fallbackRef: '' // z.B. 'gh-pages' oder 'main'
};
/** ========================== */

const els = {
  meta: document.getElementById('meta'),
  fileList: document.getElementById('fileList'),
  featuredList: document.getElementById('featuredList'),
  featuredSec: document.getElementById('featuredSec'),
  count: document.getElementById('count'),
  featuredCount: document.getElementById('featuredCount'),
  empty: document.getElementById('empty'),
  updated: document.getElementById('updated'),
  q: document.getElementById('q'),
  sort: document.getElementById('sort'),
  filter: document.getElementById('filter')
};

const state = {
  files: [],
  featured: [],
  rest: []
};

function esc(s=''){ return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }
function isHtmlName(name){ return /\.html?$/i.test(name); }
function isIndex(name){ return /^index\.html?$/i.test(name); }
function isFeatured(name){ return CONFIG.featuredPrefix && name.toLowerCase().startsWith(CONFIG.featuredPrefix.toLowerCase()); }

function detectOwnerRepoRef(){
  const u = new URL(location.href);
  const qpOwner = u.searchParams.get('owner');
  const qpRepo = u.searchParams.get('repo');
  const qpRef = u.searchParams.get('ref');

  let owner = qpOwner || '';
  let repo = qpRepo || '';
  let ref = qpRef || '';

  // Auto-Erkennung für GitHub Project Pages: owner.github.io/repo/...
  if (!owner || !repo){
    const host = location.hostname; // z.B. tmgsachsen.github.io
    const parts = location.pathname.split('/').filter(Boolean); // ["repo", ...]
    if (host.endsWith('.github.io') && parts.length){
      owner = owner || host.split('.')[0];
      repo = repo || parts[0];
    }
  }
  // Fallbacks
  owner = owner || CONFIG.fallbackOwner;
  repo  = repo  || CONFIG.fallbackRepo;
  ref   = ref   || CONFIG.fallbackRef;

  return {owner, repo, ref};
}

function card(file){
  const name = file.name;
  const url = file.browser_url; // relative Link zur Seite
  return `
    <article class="card">
      <h3>${esc(name)}</h3>
      <p class="muted">${esc(file.description || '')}</p>
      <div class="links">
        <a class="btn" href="${url}" target="_self" rel="noopener">Öffnen</a>
        <a class="btn" href="${file.html_url}" target="_blank" rel="noopener">Quelle (Repo)</a>
      </div>
    </article>
  `;
}

function render(){
  const q = els.q.value.trim().toLowerCase();
  const sort = els.sort.value;
  const filter = els.filter.value;

  let arr = state.files.slice();

  if (filter === 'featured') arr = arr.filter(f => f._featured);
  if (filter === 'nonfeatured') arr = arr.filter(f => !f._featured);

  if (q) {
    arr = arr.filter(f => f.name.toLowerCase().includes(q));
  }

  // Sortierung
  arr.sort((a,b)=>{
    if (sort === 'nameDesc') return b.name.localeCompare(a.name, 'de');
    return a.name.localeCompare(b.name, 'de');
  });

  // Featured-Block
  const feat = arr.filter(f => f._featured);
  const rest = arr.filter(f => !f._featured);

  els.featuredCount.textContent = feat.length;
  els.featuredSec.style.display = feat.length ? '' : 'none';
  els.featuredList.innerHTML = feat.map(card).join('');

  els.count.textContent = arr.length;
  els.fileList.innerHTML = rest.map(card).join('');
  els.empty.style.display = arr.length ? 'none' : '';
}

async function fetchRootHtmlFiles(owner, repo, ref){
  const headers = { 'Accept': 'application/vnd.github+json' };
  const url = new URL(`https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/`);
  if (ref) url.searchParams.set('ref', ref);

  const res = await fetch(url.toString(), {headers});
  if (!res.ok) throw new Error(`GitHub API Fehler ${res.status}`);
  const data = await res.json();
  // Nur Dateien im Root, die .html sind (ohne index.html)
  const files = (Array.isArray(data) ? data : [])
    .filter(e => e.type === 'file' && isHtmlName(e.name) && !isIndex(e.name))
    .map(e => ({
      name: e.name,
      path: e.path,
      size: e.size,
      sha: e.sha,
      html_url: `https://github.com/${owner}/${repo}/blob/${ref || 'HEAD'}/${encodeURIComponent(e.path)}`,
      // Browser-URL relativ (funktioniert auch mit Custom Domains):
      browser_url: `./${encodeURIComponent(e.name)}`,
      _featured: isFeatured(e.name)
    }));
  return files;
}

(async function init(){
  els.updated.textContent = new Date().toLocaleString('de-DE');
  const {owner, repo, ref} = detectOwnerRepoRef();

  if (!owner || !repo){
    els.meta.innerHTML = `⚠️ Owner/Repo nicht erkannt. Übergib sie per URL, z. B. <code>?owner=TMGSachsen&repo=mein-repo&ref=gh-pages</code> oder trage Fallbacks im Skript ein.`;
    return;
  }

  els.meta.textContent = `Quelle: ${owner}/${repo}${ref ? ' @ '+ref : ''} · zeigt *.html im Repo-Root`;

  try{
    const files = await fetchRootHtmlFiles(owner, repo, ref);
    state.files = files;
    render();
  }catch(e){
    els.fileList.innerHTML = `<div class="empty">Fehler beim Laden: ${esc(e.message)}. Prüfe Branch/Ref oder Repo-Berechtigungen.</div>`;
  }

  ['input','change'].forEach(ev=>{
    els.q.addEventListener(ev, render);
    els.sort.addEventListener(ev, render);
    els.filter.addEventListener(ev, render);
  });
})();
</script>
</body>
</html>
